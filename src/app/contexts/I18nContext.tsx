import React, { createContext, useContext, useState, useCallback } from 'react';

export type Language = 'fr' | 'en';

const translations = {
  fr: {
    // Navigation
    'nav.home': 'Accueil',
    'nav.vehicles': 'Véhicules',
    'nav.tasks': 'Tâches',
    'nav.settings': 'Paramètres',
    // Dashboard
    'dashboard.hello': 'Bonjour',
    'dashboard.vehicles': 'Véhicules',
    'dashboard.upcomingAlerts': 'Échéances à venir',
    'dashboard.pendingTasks': 'Tâches en attente',
    'dashboard.view': 'Voir',
    'dashboard.viewAll': 'Voir tout',
    'dashboard.nextDeadlines': 'Prochaines échéances',
    'dashboard.noVehicle': 'Aucun véhicule',
    'dashboard.addFirstVehicle': 'Ajoutez votre premier véhicule pour commencer',
    'dashboard.maintenance': 'Maintenance & Entretiens',
    'dashboard.freeVideoTutorials': 'Tutoriels vidéo gratuits et bien faits',
    'dashboard.solidGuides': 'Guides et vidéos solides (connexion requise)',
    'dashboard.practicalTutorials': 'Tutoriels pratiques pour guides et pièces',
    // Vehicles
    'vehicles.title': 'Mes Véhicules',
    'vehicles.vehicle': 'véhicule',
    'vehicles.vehicles': 'véhicules',
    'vehicles.noVehicle': 'Aucun véhicule',
    'vehicles.addFirst': 'Ajoutez votre premier véhicule',
    'vehicles.add': 'Ajouter un véhicule',
    'vehicles.edit': 'Modifier le véhicule',
    'vehicles.delete': 'Supprimer',
    'vehicles.confirmDelete': 'Supprimer',
    'vehicles.brand': 'Marque',
    'vehicles.model': 'Modèle',
    'vehicles.year': 'Année',
    'vehicles.mileage': 'Kilométrage',
    'vehicles.licensePlate': 'Immatriculation',
    'vehicles.name': 'Nom du véhicule',
    'vehicles.fuelType': 'Motorisation',
    'vehicles.driveType': 'Transmission',
    'vehicles.photo': 'Photo du véhicule',
    'vehicles.infos': 'Infos',
    'vehicles.maintenance': 'Entretien',
    'vehicles.photos': 'Photos',
    'vehicles.documents': 'Documents',
    // Maintenance
    'maintenance.title': "Carnet d'entretien",
    'maintenance.add': 'Ajouter',
    'maintenance.addTitle': 'Ajouter un entretien',
    'maintenance.edit': "Modifier l'entretien",
    'maintenance.search': 'Rechercher un entretien...',
    'maintenance.noEntry': 'Aucun entretien',
    'maintenance.addFirst': 'Ajoutez votre premier entretien',
    'maintenance.type': "Type d'entretien",
    'maintenance.date': 'Date',
    'maintenance.cost': 'Coût (€)',
    'maintenance.notes': 'Notes',
    'maintenance.save': 'Enregistrer',
    'maintenance.cancel': 'Annuler',
    'maintenance.delete': 'Supprimer',
    'maintenance.modify': 'Modifier',
    'maintenance.exportPdf': 'Exporter PDF',
    'maintenance.duplicateFound': 'Entretien déjà enregistré',
    'maintenance.duplicateMessage': 'L\'entretien « {name} » existe déjà avec le même kilométrage et la même date.',
    'maintenance.selected': 'sélectionné',
    'maintenance.selecteds': 'sélectionnés',
    'maintenance.selectAll': 'Tout sélectionner',
    'maintenance.deselectAll': 'Tout désélectionner',
    'maintenance.tip': 'Vous pouvez sélectionner plusieurs entretiens pour les ajouter en une seule fois !',
    'maintenance.noResult': 'Aucun entretien trouvé',
    'maintenance.searchResults': 'résultat(s) trouvé(s)',
    // Tasks
    'tasks.title': 'Tâches',
    'tasks.pending': 'en attente',
    'tasks.completed': 'terminée',
    'tasks.completeds': 'terminées',
    'tasks.all': 'Toutes',
    'tasks.todo': 'À faire',
    'tasks.done': 'Terminées',
    'tasks.noTask': 'Aucune tâche',
    'tasks.allDone': 'Toutes les tâches sont terminées !',
    'tasks.addFirst': 'Ajoutez votre première tâche',
    'tasks.new': 'Nouvelle tâche',
    'tasks.editTitle': 'Modifier la tâche',
    'tasks.taskTitle': 'Titre',
    'tasks.description': 'Description',
    'tasks.links': 'Liens',
    'tasks.addLink': 'Ajouter un lien',
    'tasks.selectVehicle': 'Sélectionner un véhicule',
    'tasks.create': 'Créer',
    'tasks.allVehicles': 'Tous les véhicules',
    'tasks.createdAt': 'Créée le',
    'tasks.usefulLinks': 'Liens utiles',
    // Settings
    'settings.title': 'Paramètres',
    'settings.admin': 'ADMINISTRATION',
    'settings.manageProfiles': 'Gérer les profils',
    'settings.createModifyDelete': 'Créer, modifier, supprimer',
    'settings.adminPin': 'Modifier le PIN admin',
    'settings.security': 'Sécurité',
    'settings.linkOldProfile': 'Lier un profil ancien',
    'settings.recoverData': 'Récupérer mes données',
    'settings.profile': 'PROFIL',
    'settings.editProfile': 'Modifier mon profil',
    'settings.nameAvatar': 'Nom, prénom, avatar',
    'settings.display': 'AFFICHAGE',
    'settings.fontSize': 'Taille de police',
    'settings.adjustFontSize': 'Ajuster la taille du texte',
    'settings.theme': 'Thème',
    'settings.themeDesc': 'Sombre ou clair',
    'settings.dark': 'Sombre',
    'settings.light': 'Clair',
    'settings.language': 'Langue',
    'settings.languageDesc': 'Français ou English',
    'settings.maintenanceSection': 'ENTRETIEN',
    'settings.maintenanceSettings': "Paramètres d'entretien",
    'settings.typesAndIntervals': 'Types et intervalles',
    'settings.customProfiles': "Profils d'entretien personnalisés",
    'settings.alertThresholds': "Seuils d'alertes",
    'settings.alertThresholdsDesc': 'Km et mois avant échéance',
    'settings.data': 'DONNÉES',
    'settings.recoverOldData': 'Récupérer mes anciennes données',
    'settings.resetData': 'Réinitialiser les données du profil',
    'settings.resetDataDesc': 'Supprimer véhicules, entretiens et tâches',
    // Alerts
    'alerts.title': 'Échéances à venir',
    'alerts.alert': 'alerte',
    'alerts.alerts': 'alertes',
    'alerts.close': 'proche',
    'alerts.closes': 'proches',
    'alerts.allGood': 'Tout va bien !',
    'alerts.noAlert': "Aucune échéance pour l'instant",
    'alerts.markChecked': 'Marquer comme vérifié',
    'alerts.expired': 'EXPIRÉ - Entretien nécessaire !',
    'alerts.inKm': 'Dans',
    'alerts.inDays': 'Dans',
    'alerts.day': 'jour',
    'alerts.days': 'jours',
    'alerts.scheduledFor': 'Prévu le',
    'alerts.back': 'Retour',
    // Common
    'common.cancel': 'Annuler',
    'common.save': 'Enregistrer',
    'common.add': 'Ajouter',
    'common.edit': 'Modifier',
    'common.delete': 'Supprimer',
    'common.close': 'Fermer',
    'common.confirm': 'Confirmer',
    'common.loading': 'Chargement...',
    'common.error': 'Erreur',
    'common.success': 'Succès',
    'common.gasoline': 'Essence',
    'common.diesel': 'Diesel',
    // Onboarding
    'onboarding.welcome': 'Bienvenue sur Valcar !',
    'onboarding.welcomeDesc': 'Votre carnet d\'entretien intelligent pour vos véhicules.',
    'onboarding.step1Title': 'Ajoutez vos véhicules',
    'onboarding.step1Desc': 'Enregistrez vos voitures avec photo, kilométrage et informations techniques.',
    'onboarding.step2Title': 'Suivez vos entretiens',
    'onboarding.step2Desc': '41 types d\'entretien pré-configurés avec rappels automatiques.',
    'onboarding.step3Title': 'Gérez vos tâches',
    'onboarding.step3Desc': 'Créez des tâches avec liens et suivez leur progression.',
    'onboarding.step4Title': 'Exportez en PDF',
    'onboarding.step4Desc': 'Générez un carnet d\'entretien complet pour la revente.',
    'onboarding.next': 'Suivant',
    'onboarding.skip': 'Passer',
    'onboarding.start': 'Commencer',
    // PDF
    'pdf.title': 'Carnet d\'Entretien',
    'pdf.vehicle': 'Véhicule',
    'pdf.generatedOn': 'Généré le',
    'pdf.date': 'Date',
    'pdf.type': 'Type',
    'pdf.mileage': 'Kilométrage',
    'pdf.cost': 'Coût',
    'pdf.notes': 'Notes',
    'pdf.total': 'Total des coûts',
    'pdf.noMaintenance': 'Aucun entretien enregistré',
  },
  en: {
    // Navigation
    'nav.home': 'Home',
    'nav.vehicles': 'Vehicles',
    'nav.tasks': 'Tasks',
    'nav.settings': 'Settings',
    // Dashboard
    'dashboard.hello': 'Hello',
    'dashboard.vehicles': 'Vehicles',
    'dashboard.upcomingAlerts': 'Upcoming alerts',
    'dashboard.pendingTasks': 'Pending tasks',
    'dashboard.view': 'View',
    'dashboard.viewAll': 'View all',
    'dashboard.nextDeadlines': 'Next deadlines',
    'dashboard.noVehicle': 'No vehicle',
    'dashboard.addFirstVehicle': 'Add your first vehicle to get started',
    'dashboard.maintenance': 'Maintenance & Services',
    'dashboard.freeVideoTutorials': 'Free and well-made video tutorials',
    'dashboard.solidGuides': 'Solid guides and videos (login required)',
    'dashboard.practicalTutorials': 'Practical tutorials for guides and parts',
    // Vehicles
    'vehicles.title': 'My Vehicles',
    'vehicles.vehicle': 'vehicle',
    'vehicles.vehicles': 'vehicles',
    'vehicles.noVehicle': 'No vehicle',
    'vehicles.addFirst': 'Add your first vehicle',
    'vehicles.add': 'Add a vehicle',
    'vehicles.edit': 'Edit vehicle',
    'vehicles.delete': 'Delete',
    'vehicles.confirmDelete': 'Delete',
    'vehicles.brand': 'Brand',
    'vehicles.model': 'Model',
    'vehicles.year': 'Year',
    'vehicles.mileage': 'Mileage',
    'vehicles.licensePlate': 'License plate',
    'vehicles.name': 'Vehicle name',
    'vehicles.fuelType': 'Engine type',
    'vehicles.driveType': 'Drivetrain',
    'vehicles.photo': 'Vehicle photo',
    'vehicles.infos': 'Info',
    'vehicles.maintenance': 'Maintenance',
    'vehicles.photos': 'Photos',
    'vehicles.documents': 'Documents',
    // Maintenance
    'maintenance.title': 'Maintenance Log',
    'maintenance.add': 'Add',
    'maintenance.addTitle': 'Add maintenance',
    'maintenance.edit': 'Edit maintenance',
    'maintenance.search': 'Search maintenance...',
    'maintenance.noEntry': 'No maintenance',
    'maintenance.addFirst': 'Add your first maintenance entry',
    'maintenance.type': 'Maintenance type',
    'maintenance.date': 'Date',
    'maintenance.cost': 'Cost (€)',
    'maintenance.notes': 'Notes',
    'maintenance.save': 'Save',
    'maintenance.cancel': 'Cancel',
    'maintenance.delete': 'Delete',
    'maintenance.modify': 'Edit',
    'maintenance.exportPdf': 'Export PDF',
    'maintenance.duplicateFound': 'Maintenance already recorded',
    'maintenance.duplicateMessage': 'The maintenance "{name}" already exists with the same mileage and date.',
    'maintenance.selected': 'selected',
    'maintenance.selecteds': 'selected',
    'maintenance.selectAll': 'Select all',
    'maintenance.deselectAll': 'Deselect all',
    'maintenance.tip': 'You can select multiple maintenance items to add them all at once!',
    'maintenance.noResult': 'No maintenance found',
    'maintenance.searchResults': 'result(s) found',
    // Tasks
    'tasks.title': 'Tasks',
    'tasks.pending': 'pending',
    'tasks.completed': 'completed',
    'tasks.completeds': 'completed',
    'tasks.all': 'All',
    'tasks.todo': 'To do',
    'tasks.done': 'Completed',
    'tasks.noTask': 'No task',
    'tasks.allDone': 'All tasks completed!',
    'tasks.addFirst': 'Add your first task',
    'tasks.new': 'New task',
    'tasks.editTitle': 'Edit task',
    'tasks.taskTitle': 'Title',
    'tasks.description': 'Description',
    'tasks.links': 'Links',
    'tasks.addLink': 'Add a link',
    'tasks.selectVehicle': 'Select a vehicle',
    'tasks.create': 'Create',
    'tasks.allVehicles': 'All vehicles',
    'tasks.createdAt': 'Created on',
    'tasks.usefulLinks': 'Useful links',
    // Settings
    'settings.title': 'Settings',
    'settings.admin': 'ADMINISTRATION',
    'settings.manageProfiles': 'Manage profiles',
    'settings.createModifyDelete': 'Create, edit, delete',
    'settings.adminPin': 'Change admin PIN',
    'settings.security': 'Security',
    'settings.linkOldProfile': 'Link old profile',
    'settings.recoverData': 'Recover my data',
    'settings.profile': 'PROFILE',
    'settings.editProfile': 'Edit my profile',
    'settings.nameAvatar': 'Name, avatar',
    'settings.display': 'DISPLAY',
    'settings.fontSize': 'Font size',
    'settings.adjustFontSize': 'Adjust text size',
    'settings.theme': 'Theme',
    'settings.themeDesc': 'Dark or light',
    'settings.dark': 'Dark',
    'settings.light': 'Light',
    'settings.language': 'Language',
    'settings.languageDesc': 'Français or English',
    'settings.maintenanceSection': 'MAINTENANCE',
    'settings.maintenanceSettings': 'Maintenance settings',
    'settings.typesAndIntervals': 'Types and intervals',
    'settings.customProfiles': 'Custom maintenance profiles',
    'settings.alertThresholds': 'Alert thresholds',
    'settings.alertThresholdsDesc': 'Km and months before deadline',
    'settings.data': 'DATA',
    'settings.recoverOldData': 'Recover my old data',
    'settings.resetData': 'Reset profile data',
    'settings.resetDataDesc': 'Delete vehicles, maintenance and tasks',
    // Alerts
    'alerts.title': 'Upcoming deadlines',
    'alerts.alert': 'alert',
    'alerts.alerts': 'alerts',
    'alerts.close': 'near',
    'alerts.closes': 'near',
    'alerts.allGood': 'All good!',
    'alerts.noAlert': 'No upcoming deadlines',
    'alerts.markChecked': 'Mark as checked',
    'alerts.expired': 'EXPIRED - Maintenance needed!',
    'alerts.inKm': 'In',
    'alerts.inDays': 'In',
    'alerts.day': 'day',
    'alerts.days': 'days',
    'alerts.scheduledFor': 'Scheduled for',
    'alerts.back': 'Back',
    // Common
    'common.cancel': 'Cancel',
    'common.save': 'Save',
    'common.add': 'Add',
    'common.edit': 'Edit',
    'common.delete': 'Delete',
    'common.close': 'Close',
    'common.confirm': 'Confirm',
    'common.loading': 'Loading...',
    'common.error': 'Error',
    'common.success': 'Success',
    'common.gasoline': 'Gasoline',
    'common.diesel': 'Diesel',
    // Onboarding
    'onboarding.welcome': 'Welcome to Valcar!',
    'onboarding.welcomeDesc': 'Your smart maintenance log for your vehicles.',
    'onboarding.step1Title': 'Add your vehicles',
    'onboarding.step1Desc': 'Register your cars with photos, mileage and technical info.',
    'onboarding.step2Title': 'Track your maintenance',
    'onboarding.step2Desc': '41 pre-configured maintenance types with automatic reminders.',
    'onboarding.step3Title': 'Manage your tasks',
    'onboarding.step3Desc': 'Create tasks with links and track their progress.',
    'onboarding.step4Title': 'Export to PDF',
    'onboarding.step4Desc': 'Generate a complete maintenance log for resale.',
    'onboarding.next': 'Next',
    'onboarding.skip': 'Skip',
    'onboarding.start': 'Get Started',
    // PDF
    'pdf.title': 'Maintenance Log',
    'pdf.vehicle': 'Vehicle',
    'pdf.generatedOn': 'Generated on',
    'pdf.date': 'Date',
    'pdf.type': 'Type',
    'pdf.mileage': 'Mileage',
    'pdf.cost': 'Cost',
    'pdf.notes': 'Notes',
    'pdf.total': 'Total costs',
    'pdf.noMaintenance': 'No maintenance recorded',
  },
} as const;

type TranslationKey = keyof typeof translations.fr;

interface I18nContextType {
  lang: Language;
  setLang: (lang: Language) => void;
  t: (key: TranslationKey, params?: Record<string, string>) => string;
}

const I18nContext = createContext<I18nContextType | undefined>(undefined);

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLang] = useState<Language>(() => {
    const saved = localStorage.getItem('valcar-lang');
    return (saved === 'en' ? 'en' : 'fr') as Language;
  });

  const changeLang = useCallback((newLang: Language) => {
    setLang(newLang);
    localStorage.setItem('valcar-lang', newLang);
  }, []);

  const t = useCallback((key: TranslationKey, params?: Record<string, string>): string => {
    let text = (translations[lang] as any)[key] || (translations.fr as any)[key] || key;
    if (params) {
      Object.entries(params).forEach(([k, v]) => {
        text = text.replace(`{${k}}`, v);
      });
    }
    return text;
  }, [lang]);

  return (
    <I18nContext.Provider value={{ lang, setLang: changeLang, t }}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    // Fallback for dev/hot-reload
    return {
      lang: 'fr' as Language,
      setLang: () => {},
      t: (key: string) => key,
    } as I18nContextType;
  }
  return context;
}
